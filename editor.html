<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rich Text Editor</title>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* Base */
    body { margin: 0; font-family: sans-serif; }
    #toolbar { background: #f3f3f3; border-bottom: 1px solid #ccc; padding: 6px 8px; }
    #editor { height: calc(100vh - 56px); padding: 4px 8px; overflow-y: auto; }

    /* Quill content area */
    .ql-editor { padding: 4px 6px; }

    /* ðŸ‘‰ Match EventList.jsx tag spacing & styles */
    .ql-editor a {
      color: #D32F2F;
      font-weight: 700;
      text-decoration: underline;
      text-decoration-color: #D32F2F;
      line-height: 18px;
    }
    .ql-editor span {
      color: #000;
      line-height: 15px;
    }
    .ql-editor p {
      margin-top: 5px;      /* EventList: p { marginTop: 5 } */
      margin-bottom: 2px;   /* EventList: p { marginBottom: 2 } */
      line-height: 18px;    /* EventList: p { lineHeight: 18 } */
    }

    /* Lists */
    .ql-editor ul { padding-left: 25px; margin-top: 2px; margin-bottom: 2px; }
    .ql-editor ol { padding-left: 30px; margin-top: 2px; margin-bottom: 2px; }
    .ql-editor li  {
      margin-top: 0;
      margin-bottom: 0;
      list-style-position: inside;
      padding-left: 3px;
    }
    .ql-editor li p { margin-top: 0; margin-bottom: 0; }

    /* Images */
    .ql-editor img {
      max-width: 100%;   /* donâ€™t overflow container */
      height: auto;      /* natural aspect ratio in editor view */
      display: block;
    }

    /* Text alignment (unchanged) */
    .ql-editor .ql-align-center { text-align: center; }
    .ql-editor .ql-align-right  { text-align: right; }
    .ql-editor .ql-align-justify { text-align: justify; }

    /* âœ… Image alignment â€” handle every way Quill may encode it */

    /* Centered */
    .ql-editor .ql-align-center img,
    .ql-editor img.ql-align-center,
    .ql-editor img[data-align="center"],
    .ql-editor [style*="text-align:center"] > img {
      display: block;
      margin-left: auto;
      margin-right: auto;
      float: none;       /* make sure floats donâ€™t override centering */
    }

    /* Right */
    .ql-editor .ql-align-right img,
    .ql-editor img.ql-align-right,
    .ql-editor img[data-align="right"],
    .ql-editor [style*="text-align:right"] > img {
      display: block;
      margin-left: auto;
      margin-right: 0;
      float: right;      /* match Quillâ€™s right-alignment behavior */
    }

    /* Left (explicit) */
    .ql-editor .ql-align-left img,
    .ql-editor img.ql-align-left,
    .ql-editor img[data-align="left"],
    .ql-editor [style*="text-align:left"] > img {
      display: block;
      margin-left: 0;
      margin-right: auto;
      float: left;
    }

  </style>
</head>
<body>

  <!-- Toolbar -->
  <div id="toolbar">
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <select class="ql-color"></select>

      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>

      <button class="ql-link"></button>
      <button class="ql-image"></button>
      <select class="ql-background"></select>

      <select class="ql-align"></select>
    </span>
  </div>

  <!-- Quill Editor -->
  <div id="editor"></div>

  <script>
    let quill = null;
    let isQuillReady = false;
    const pendingMessages = [];

    const safeOrigin = () => {
      return document.referrer?.startsWith('http')
        ? new URL(document.referrer).origin
        : '*';
    };

    const sendEditorReady = () => {
      if (isQuillReady) {
        window.parent.postMessage({ type: 'editorReady' }, safeOrigin());
      }
    };

    /* ---------- Image helpers (default/custom size prompt) ---------- */
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function askImageSize() {
      const useDefault = window.confirm('Use default image size 300Ã—300px?\nOK = Default,  Cancel = Custom size');
      if (useDefault) return { width: 300, height: 300 };

      const wStr = window.prompt('Enter image WIDTH in pixels (e.g., 300):', '300');
      const hStr = window.prompt('Enter image HEIGHT in pixels (e.g., 300):', '300');

      let w = parseInt(wStr, 10);
      let h = parseInt(hStr, 10);

      if (Number.isNaN(w)) w = 300;
      if (Number.isNaN(h)) h = 300;

      w = clamp(w, 10, 4000);
      h = clamp(h, 10, 4000);

      return { width: w, height: h };
    }

    function insertImageWithSize(dataUrl, w, h) {
      const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
      quill.insertEmbed(range.index, 'image', dataUrl, 'user');
      quill.setSelection(range.index + 1, 0, 'silent');

      // Try to grab the just-inserted <img>
      const [leaf] = quill.getLeaf(range.index);
      let img = (leaf && leaf.domNode && leaf.domNode.tagName === 'IMG') ? leaf.domNode : null;

      if (!img) {
        const imgs = quill.root.querySelectorAll('img');
        if (imgs.length) img = imgs[imgs.length - 1];
      }

      if (img) {
        img.style.width = w + 'px';
        img.style.height = h + 'px';   // fixed height to match chosen size
        img.style.maxWidth = '100%';   // prevent overflow on small screens
      }
    }

    function customImageHandler() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = () => {
        const file = input.files && input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          const { width, height } = askImageSize();
          insertImageWithSize(reader.result, width, height);
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    /* ---------- Initialize Quill ---------- */
    window.addEventListener('DOMContentLoaded', () => {
      quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Type your description...',
        modules: {
          toolbar: {
            container: '#toolbar',
            handlers: {
              image: customImageHandler
            }
          }
          // Alignment module is auto-enabled via <select class="ql-align">
        }
      });

      isQuillReady = true;
      setTimeout(sendEditorReady, 50);

      // Process any queued messages
      while (pendingMessages.length) {
        const evt = pendingMessages.shift();
        processMessage(evt);
      }
    });

    /* ---------- Messaging bridge ---------- */
    const processMessage = (event) => {
      const data = event.data;

      if (data === 'getContent') {
        const html = quill.root.innerHTML;
        window.parent.postMessage({ html }, event.origin);
        return;
      }

      if (data?.type === 'setContent') {
        const incomingHtml = data.html || '';
        try {
          const delta = quill.clipboard.convert(incomingHtml);
          quill.setContents(delta);
        } catch (e) {
          // If conversion loses styles, fall back to raw HTML
          console.warn('Falling back to innerHTML for setContent.', e);
          quill.root.innerHTML = incomingHtml;
        }
      }
    };

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (data?.type === 'ping') {
        sendEditorReady();
        return;
      }
      if (!isQuillReady) {
        pendingMessages.push(event);
        return;
      }
      processMessage(event);
    });
  </script>
</body>
</html>

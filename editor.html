<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rich Text Editor</title>

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #toolbar { background: #f3f3f3; border-bottom: 1px solid #ccc; padding: 6px 8px; }

    /* Editor area */
    #editor { height: calc(100vh - 56px); padding: 4px 8px; overflow-y: auto; }

    /* Tight text spacing + responsive images (we'll still set explicit px on insert) */
    .ql-editor { padding: 4px 6px; }
    .ql-editor p { margin-top: 0; margin-bottom: 0; }
    .ql-editor img { max-width: 100%; height: auto; display: block; }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div id="toolbar">
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <select class="ql-color"></select>

      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>

      <button class="ql-link"></button>
      <button class="ql-image"></button>
      <select class="ql-background"></select>

      <select class="ql-align"></select>
    </span>
  </div>

  <!-- Quill Editor -->
  <div id="editor"></div>

  <script>
    let quill = null;
    let isQuillReady = false;
    const pendingMessages = [];

    const safeOrigin = () => {
      return document.referrer?.startsWith('http')
        ? new URL(document.referrer).origin
        : '*';
    };

    const sendEditorReady = () => {
      if (isQuillReady) {
        window.parent.postMessage({ type: 'editorReady' }, safeOrigin());
      }
    };

    // ---- IMAGE INSERT HELPERS ----
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function askImageSize() {
      // OK -> default 300x300, Cancel -> custom
      const useDefault = window.confirm('Use default image size 300×300px? \nOK = Default,  Cancel = Custom size');
      if (useDefault) return { width: 300, height: 300 };

      const wStr = window.prompt('Enter image WIDTH in pixels (e.g., 300):', '300');
      const hStr = window.prompt('Enter image HEIGHT in pixels (e.g., 300):', '300');

      let w = parseInt(wStr, 10);
      let h = parseInt(hStr, 10);

      if (Number.isNaN(w)) w = 300;
      if (Number.isNaN(h)) h = 300;

      // simple sanity limits
      w = clamp(w, 10, 4000);
      h = clamp(h, 10, 4000);

      return { width: w, height: h };
    }

    function insertImageWithSize(dataUrl, w, h) {
      const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
      quill.insertEmbed(range.index, 'image', dataUrl, 'user');
      quill.setSelection(range.index + 1, 0, 'silent');

      // Try to grab the img we just inserted
      const [leaf] = quill.getLeaf(range.index);
      let img = (leaf && leaf.domNode && leaf.domNode.tagName === 'IMG') ? leaf.domNode : null;

      // Fallback: last image in editor
      if (!img) {
        const imgs = quill.root.querySelectorAll('img');
        if (imgs.length) img = imgs[imgs.length - 1];
      }

      if (img) {
        // Apply explicit pixel dimensions so it persists in saved HTML
        img.style.width = w + 'px';
        img.style.height = h + 'px';
        img.style.maxWidth = '100%'; // don’t overflow container if user picks very large dimensions
        img.style.height = h + 'px'; // keep requested height (may distort if different aspect ratio)
      }
    }

    function customImageHandler() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = () => {
        const file = input.files && input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const { width, height } = askImageSize();
          insertImageWithSize(reader.result, width, height);
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    // ---- Initialize Quill ----
    window.addEventListener('DOMContentLoaded', () => {
      quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Type your description...',
        modules: {
          toolbar: {
            container: '#toolbar',
            handlers: {
              image: customImageHandler // <-- override default image flow
            }
          }
        }
      });

      isQuillReady = true;
      setTimeout(sendEditorReady, 50);

      // Drain queued messages
      while (pendingMessages.length) {
        const evt = pendingMessages.shift();
        processMessage(evt);
      }
    });

    // ---- Messaging with parent ----
    const processMessage = (event) => {
      const data = event.data;

      if (data === 'getContent') {
        const html = quill.root.innerHTML;
        window.parent.postMessage({ html }, event.origin);
        return;
      }

      if (data?.type === 'setContent') {
        const incomingHtml = data.html || '';
        try {
          // Try normal paste first; if styles are important and get lost, fall back to innerHTML
          const delta = quill.clipboard.convert(incomingHtml);
          quill.setContents(delta);
        } catch (e) {
          console.warn('Falling back to innerHTML for setContent due to conversion error.', e);
          quill.root.innerHTML = incomingHtml;
        }
      }
    };

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (data?.type === 'ping') {
        sendEditorReady();
        return;
      }
      if (!isQuillReady) {
        pendingMessages.push(event);
        return;
      }
      processMessage(event);
    });
  </script>
</body>
</html>
